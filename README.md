# DufsGUI - Dufs 多服务管理工具

DufsGUI 是一个基于 PyQt5 开发的图形界面工具，用于管理多个 Dufs 文件服务器服务，并支持通过 Cloudflared 实现内网穿透，让外部网络可以访问本地文件。

## 功能特性

### 核心功能
- **多服务管理**：支持添加、编辑、删除多个 Dufs 服务
- **一键启动/停止**：快速启动或停止内网共享和公网访问
- **服务状态监控**：实时显示服务运行状态（运行中、已停止、启动中、错误）
- **智能端口分配**：自动检测端口占用，避免端口冲突
- **端口黑名单过滤**：自动屏蔽浏览器和系统保留端口

### 网络功能
- **本地访问**：自动获取本机 IP，生成本地访问地址
- **公网访问**：集成 Cloudflared 隧道，无需公网 IP 即可外网访问
- **自动下载**：首次使用公网功能时自动下载 Cloudflared
- **重试机制**：下载失败自动重试，支持手动重试

### 权限管理
- **上传控制**：允许/禁止客户端上传文件
- **删除控制**：允许/禁止客户端删除文件
- **搜索控制**：允许/禁止客户端搜索文件
- **存档控制**：允许/禁止客户端下载目录压缩包
- **一键授权**：支持一键允许所有操作

### 日志与监控
- **实时日志**：显示服务运行日志，支持多服务日志切换
- **结构化日志**：支持日志级别过滤（DEBUG/INFO/WARNING/ERROR/CRITICAL）
- **系统托盘**：最小化到托盘，后台运行不打扰
- **配置持久化**：自动保存服务配置到本地

### 智能功能
- **名称冲突处理**：自动检测并更换重复的服务名称
- **端口冲突处理**：自动检测并更换冲突的端口号
- **编辑自动重启**：编辑运行中的服务后自动重启
- **残留进程清理**：启动时自动清理残留的 dufs 进程
- **延迟加载**：按需加载模块，优化启动性能

## 系统要求

- **操作系统**：Windows 10/11
- **Python 版本**：3.8+
- **依赖组件**：
  - PyQt5
  - requests
  - pywin32（Windows 系统托盘支持）

## 安装方法

### 1. 克隆仓库
```bash
git clone https://github.com/tysonye/dufs-gui.git
cd dufs-gui
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 准备可执行文件
将以下文件放置在项目根目录：
- `dufs.exe` - Dufs 文件服务器程序
- `cloudflared.exe` - Cloudflare 隧道程序（可选，首次使用公网功能时会自动下载）

## 使用方法

### 启动程序
```bash
python main.py
```

### 创建服务
1. 点击「添加服务」按钮
2. 填写服务名称（如：文档共享）
3. 选择服务路径（要共享的文件夹）
4. 配置端口号（留空则自动分配）
5. 设置权限（上传、删除、搜索等）
6. 点击「确定」保存

### 启动服务
1. 在服务列表中选择要启动的服务
2. 点击「启动内网共享」按钮
3. 服务启动后，本地访问地址会显示在下方

### 开启公网访问
1. 确保内网共享已启动
2. 点击「启动公网共享」按钮
3. 首次使用会提示下载 Cloudflared
4. 等待生成公网访问地址（约 10-30 秒）
5. 公网地址显示后即可通过外网访问

### 编辑服务
1. 选择要编辑的服务
2. 点击「编辑服务」按钮
3. 修改配置后点击「确定」
4. 如果服务正在运行，会自动重启

### 停止服务
- **停止内网共享**：点击「停止共享服务」
- **停止公网访问**：右键点击服务，选择「停止公网共享」

## 配置说明

### 服务配置
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 服务名称 | 服务的唯一标识 | 默认服务 |
| 服务路径 | 要共享的文件夹路径 | 当前目录 |
| 端口 | 服务监听端口 | 自动分配 |
| 绑定地址 | 服务绑定 IP，留空表示所有地址 | 空 |

### 权限配置
| 权限 | 说明 |
|------|------|
| 允许上传 | 允许客户端上传文件到服务器 |
| 允许删除 | 允许客户端删除服务器上的文件 |
| 允许搜索 | 允许客户端搜索文件 |
| 允许存档 | 允许客户端下载目录压缩包 |
| 允许所有操作 | 启用所有权限 |

## 项目结构

```
dufs-gui/
├── main.py                      # 程序入口
├── main_window.py               # 主窗口界面
├── main_view.py                 # 主窗口视图层
├── main_controller.py           # 主窗口控制器（协调者模式）
│
├── service.py                   # 服务模块入口（协调者）
├── base_service.py              # 基础服务类
├── cloudflare_tunnel.py         # Cloudflare 隧道管理
├── service_state_machine.py     # 服务状态机
├── service_state.py             # 服务状态枚举（现代化状态管理）
├── service_manager.py           # 多服务管理器
├── service_dialog.py            # 服务配置对话框
├── service_info_dialog.py       # 服务信息对话框
│
├── config_controller.py         # 配置控制器
├── service_controller.py        # 服务控制器
├── tray_controller.py           # 托盘控制器
│
├── tray_manager.py              # 系统托盘管理器
├── tray_menu_builder.py         # 托盘菜单构建器
├── tray_event_handler.py        # 托盘事件处理器
│
├── log_manager.py               # 日志管理器（线程安全）
├── log_window.py                # 日志窗口
├── structured_log.py            # 结构化日志系统
│
├── config_manager.py            # 配置管理器
├── auto_saver.py                # 自动保存器
├── startup_manager.py           # 开机启动管理器
│
├── cloudflared_downloader.py    # Cloudflared 下载器
├── event_bus.py                 # 事件总线（发布-订阅模式）
├── lazy_loader.py               # 延迟加载器（性能优化）
│
├── constants.py                 # 常量定义
├── utils.py                     # 工具函数
├── build.py                     # 构建脚本
├── requirements.txt             # 依赖列表
└── README.md                    # 说明文档
```

## 架构设计

### 1. 分层架构
- **视图层（View）**：`main_window.py`, `main_view.py`
- **控制层（Controller）**：`main_controller.py`, `*_controller.py`
- **服务层（Service）**：`service.py`, `base_service.py`, `service_manager.py`
- **数据层（Data）**：`config_manager.py`

### 2. 设计模式
- **协调者模式**：`main_controller.py` 协调多个子控制器
- **组合模式**：`tray_manager.py` 组合 `menu_builder` 和 `event_handler`
- **状态机模式**：`service_state_machine.py` 管理服务状态转换
- **发布-订阅模式**：`event_bus.py` 解耦模块间通信
- **延迟加载**：`lazy_loader.py` 优化启动性能

### 3. 线程安全
- 所有状态更新使用线程锁保护
- 日志缓冲区使用锁保护并发写入
- 托盘菜单更新使用锁保护服务列表访问

## 端口管理

### 浏览器黑名单端口
程序会自动屏蔽以下浏览器禁止访问的端口：
- 系统端口：1, 7, 9, 11, 13, 15, 17, 19, 20, 21, 22, 23, 25...
- 邮件端口：109, 110, 143, 465, 587, 993, 995...
- 数据库端口：3306, 5432, 6379, 27017...
- 其他端口：6000, 6665-6669, 10080...

### 端口分配策略
1. 优先使用用户指定的端口
2. 如果端口被占用或为黑名单端口，自动查找可用端口
3. 端口范围：5000-9999，备选 8000-8999

## 配置文件

配置文件存储在：`%APPDATA%\DufsGUI\dufs_config.json`

包含内容：
- 服务列表（名称、路径、端口、权限等）
- 自动保存，无需手动维护

## 性能优化

### 延迟加载
- `service_info_dialog` - 只在双击服务时加载
- `startup_manager` - 只在设置开机自启时加载
- `cloudflared_downloader` - 只在启动公网共享时加载

### 预期效果
- 启动时间减少 30-40%
- 内存占用降低（按需加载）

## 常见问题

### Q: 启动服务时提示端口被占用？
A: 程序会自动更换为其他可用端口，无需手动处理。

### Q: 公网访问启动失败？
A: 检查网络连接，或尝试开启代理后重新下载 Cloudflared。

### Q: 如何查看日志？
A: 点击服务列表中的「查看」按钮，或在日志窗口中切换服务标签。

### Q: 服务名称可以重复吗？
A: 不可以，程序会自动为重复名称添加后缀（如：默认_1）。

### Q: 如何彻底删除服务？
A: 选中服务后点击「删除服务」，会自动停止服务并删除配置。

## 技术栈

- **GUI 框架**：PyQt5
- **网络请求**：requests
- **进程管理**：subprocess
- **配置存储**：JSON
- **系统托盘**：pywin32
- **设计模式**：协调者、组合、状态机、发布-订阅

## 许可证

MIT License

## 致谢

- [Dufs](https://github.com/sigoden/dufs) - 简单实用的文件服务器
- [Cloudflared](https://github.com/cloudflare/cloudflared) - Cloudflare 隧道工具
