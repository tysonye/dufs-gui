æœ€ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰
1. æœåŠ¡åœæ­¢åUIçŠ¶æ€æœªæ›´æ–°ï¼ˆé«˜é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨stop_serviceæ–¹æ³•ä¸­
with service.lock:
    service.running = False
    service.process = None
    service.status = "æœªè¿è¡Œ"
    service.local_addr = ""

# æœªè°ƒç”¨self.status_updated.emit()ï¼Œå¯¼è‡´UIçŠ¶æ€ä¸æ›´æ–°
å½±å“ï¼šç”¨æˆ·ç•Œé¢æ˜¾ç¤ºæœåŠ¡ä»ä¸º"è¿è¡Œä¸­"ï¼Œä½†å®é™…å·²åœæ­¢ï¼Œå¯¼è‡´ä¸¥é‡è¯¯åˆ¤
ä¿®å¤ï¼šåœ¨çŠ¶æ€æ›´æ–°åæ·»åŠ self.status_updated.emit()
2. æœåŠ¡è·¯å¾„ä¸ºç©ºæ—¶å´©æºƒï¼ˆé«˜é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨_build_commandä¸­
command.append(service.serve_path)  # æœªæ£€æŸ¥è·¯å¾„æ˜¯å¦ä¸ºç©º

# åœ¨_start_service_processä¸­
if not os.path.exists(service.serve_path):  # æœªæ£€æŸ¥ç©ºè·¯å¾„
å½±å“ï¼šå½“æœåŠ¡è·¯å¾„ä¸ºç©ºæ—¶ï¼Œç¨‹åºå´©æºƒ
ä¿®å¤ï¼š
python

ç¼–è¾‘



if not service.serve_path.strip():
    QMessageBox.critical(self, "é”™è¯¯", "æœåŠ¡è·¯å¾„ä¸èƒ½ä¸ºç©º")
    return False
3. ç«¯å£è¾“å…¥éæ•°å­—æ—¶å´©æºƒï¼ˆé«˜é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨_find_available_portä¸­
original_port = int(service.port.strip())  # æœªå¤„ç†éæ•°å­—è¾“å…¥
å½±å“ï¼šå½“ç”¨æˆ·è¾“å…¥éæ•°å­—ç«¯å£ï¼ˆå¦‚"abc"ï¼‰æ—¶ï¼Œç¨‹åºå´©æºƒ
ä¿®å¤ï¼š
python

ç¼–è¾‘



try:
    original_port = int(service.port.strip())
    if original_port < 1 or original_port > 65535:
        raise ValueError("ç«¯å£å¿…é¡»åœ¨1-65535ä¹‹é—´")
except ValueError:
    QMessageBox.critical(self, "é”™è¯¯", "ç«¯å£å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•´æ•°")
    return None
4. æœåŠ¡è·¯å¾„åŒ…å«ç©ºæ ¼å¯¼è‡´å‘½ä»¤è¡Œè§£æé”™è¯¯ï¼ˆé«˜é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨_build_commandä¸­
command.append(service.serve_path)  # æœªå¤„ç†ç©ºæ ¼
å½±å“ï¼šå½“æœåŠ¡è·¯å¾„åŒ…å«ç©ºæ ¼ï¼ˆå¦‚"C:/My Folder"ï¼‰æ—¶ï¼ŒDufsæ— æ³•æ­£ç¡®è§£æè·¯å¾„
ä¿®å¤ï¼š
python

ç¼–è¾‘



import shlex
service_path = shlex.quote(service.serve_path)
command.append(service_path)
ğŸŸ  ä¸­ç­‰é£é™©é—®é¢˜
1. æœåŠ¡è·¯å¾„æƒé™æ£€æŸ¥ä¸å……åˆ†ï¼ˆä¸­ç­‰é£é™©ï¼‰
python

ç¼–è¾‘



# ä»…æ£€æŸ¥è¯»å–æƒé™
if not os.access(service.serve_path, os.R_OK):
å½±å“ï¼šDufså¯èƒ½éœ€è¦å†™å…¥æƒé™ï¼ˆå¦‚åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼‰
ä¿®å¤ï¼š
python

ç¼–è¾‘



if not os.access(service.serve_path, os.R_OK | os.W_OK):
2. æ—¥å¿—çº¿ç¨‹æœªæ­£ç¡®ç»ˆæ­¢ï¼ˆä¸­ç­‰é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨stop_serviceä¸­
# æœªç¡®ä¿æ—¥å¿—è¯»å–çº¿ç¨‹å·²ç»ˆæ­¢
å½±å“ï¼šæœåŠ¡åœæ­¢åï¼Œæ—¥å¿—çº¿ç¨‹å¯èƒ½ä»åœ¨å°è¯•è¯»å–å·²å…³é—­çš„ç®¡é“ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
ä¿®å¤ï¼š
python

ç¼–è¾‘



# åœ¨stop_serviceä¸­æ·»åŠ 
if hasattr(service, 'log_thread_terminate'):
    service.log_thread_terminate = True
3. æœåŠ¡è·¯å¾„æœªè§„èŒƒåŒ–ï¼ˆä¸­ç­‰é£é™©ï¼‰
python

ç¼–è¾‘



# æœªå¤„ç†ç›¸å¯¹è·¯å¾„ã€ç¬¦å·é“¾æ¥ç­‰
å½±å“ï¼šç›¸å¯¹è·¯å¾„å¯èƒ½å¯¼è‡´Dufsè§£æé”™è¯¯
ä¿®å¤ï¼š
python

ç¼–è¾‘



service.serve_path = os.path.abspath(service.serve_path)
4. è®¤è¯è§„åˆ™å¤„ç†ä¸å®‰å…¨ï¼ˆä¸­ç­‰é£é™©ï¼‰
python

ç¼–è¾‘



# åœ¨_build_commandä¸­
if service.auth_rules:
    for rule in service.auth_rules:
        # æœªæ£€æŸ¥service.auth_rulesæ˜¯å¦ä¸ºåˆ—è¡¨
å½±å“ï¼šå¦‚æœservice.auth_rulesä¸ºNoneï¼Œä¼šå¼•å‘é”™è¯¯
ä¿®å¤ï¼š
python

ç¼–è¾‘



if service.auth_rules and isinstance(service.auth_rules, list) and len(service.auth_rules) > 0:
ğŸŸ¢ ä½é£é™©é—®é¢˜
1. æœåŠ¡è·¯å¾„æ£€æŸ¥ä¸å®Œæ•´ï¼ˆä½é£é™©ï¼‰
python

ç¼–è¾‘



# æœªæ£€æŸ¥è·¯å¾„æ˜¯å¦ä¸ºç›®å½•
if not os.path.exists(service.serve_path):
å½±å“ï¼šè·¯å¾„å­˜åœ¨ä½†ä¸æ˜¯ç›®å½•æ—¶ï¼ŒDufsä¼šå¤±è´¥
ä¿®å¤ï¼š
python

ç¼–è¾‘



if not os.path.isdir(service.serve_path):
    QMessageBox.critical(self, "é”™è¯¯", "æœåŠ¡è·¯å¾„å¿…é¡»æ˜¯ç›®å½•")
    return False
2. æœåŠ¡å¯åŠ¨æ—¶çš„å‘½ä»¤è¡Œå‚æ•°æœªä¼˜åŒ–ï¼ˆä½é£é™©ï¼‰
python

ç¼–è¾‘



# æœªä½¿ç”¨shlex.quoteå¤„ç†è·¯å¾„
å½±å“ï¼šè·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦æ—¶å¯èƒ½è§£æé”™è¯¯
ä¿®å¤ï¼šå·²åŒ…å«åœ¨é«˜é£é™©é—®é¢˜ä¸­
3. ç«¯å£èŒƒå›´æœªéªŒè¯ï¼ˆä½é£é™©ï¼‰
python

ç¼–è¾‘



# æœªéªŒè¯ç«¯å£æ˜¯å¦åœ¨1-65535èŒƒå›´å†…
å½±å“ï¼šç”¨æˆ·å¯èƒ½è¾“å…¥æ— æ•ˆç«¯å£
ä¿®å¤ï¼šå·²åŒ…å«åœ¨é«˜é£é™©é—®é¢˜ä¸­
âš ï¸ æ½œåœ¨é£é™©
1. æœåŠ¡çŠ¶æ€ç®¡ç†çº¿ç¨‹å®‰å…¨é—®é¢˜
python

ç¼–è¾‘



# åœ¨monitor_serviceä¸­
with service.lock:
    if not service.running or service.process is None:
        break
é£é™©ï¼šåœ¨service.processè¢«ç½®ä¸ºNoneåï¼Œpoll_result = service.process.poll()å¯èƒ½å¼•å‘AttributeError
ä¿®å¤ï¼š
python

ç¼–è¾‘



with service.lock:
    if not service.running or service.process is None:
        break
    poll_result = service.process.poll()
2. æœåŠ¡å¯åŠ¨æ—¶çš„è¿›ç¨‹çŠ¶æ€æ£€æŸ¥ä¸å®Œå–„
python

ç¼–è¾‘



# åœ¨_delayed_check_service_startedä¸­
poll_result = service.process.poll()
é£é™©ï¼šå¦‚æœservice.processåœ¨with service.lockä¸­è¢«ç½®ä¸ºNoneï¼Œè¿™é‡Œä¼šå¼•å‘é”™è¯¯
ä¿®å¤ï¼šç¡®ä¿åœ¨æ£€æŸ¥å‰æœåŠ¡è¿›ç¨‹ä»ç„¶å­˜åœ¨
ğŸ”§ ä¿®å¤å»ºè®®æ€»ç»“
1. ä¼˜å…ˆä¿®å¤ï¼ˆé«˜é£é™©é—®é¢˜ï¼‰
æ–‡ä»¶ï¼šdufs_multi_gui_pyqt.py
ä¿®å¤1ï¼šæœåŠ¡è·¯å¾„ç©ºå€¼æ£€æŸ¥
python

ç¼–è¾‘



# åœ¨_start_service_processæ–¹æ³•ä¸­
if not service.serve_path.strip():
    QMessageBox.critical(self, "é”™è¯¯", "æœåŠ¡è·¯å¾„ä¸èƒ½ä¸ºç©º")
    return False
ä¿®å¤2ï¼šç«¯å£è¾“å…¥éªŒè¯
python

ç¼–è¾‘



# åœ¨_find_available_portæ–¹æ³•ä¸­
try:
    original_port = int(service.port.strip())
    if original_port < 1 or original_port > 65535:
        raise ValueError("ç«¯å£å¿…é¡»åœ¨1-65535ä¹‹é—´")
except ValueError as e:
    QMessageBox.critical(self, "é”™è¯¯", str(e))
    return None
ä¿®å¤3ï¼šæœåŠ¡åœæ­¢åUIæ›´æ–°
python

ç¼–è¾‘



# åœ¨stop_serviceæ–¹æ³•æœ«å°¾æ·»åŠ 
self.status_updated.emit()
ä¿®å¤4ï¼šè·¯å¾„ç‰¹æ®Šå­—ç¬¦å¤„ç†
python

ç¼–è¾‘



# åœ¨_build_commandæ–¹æ³•ä¸­
import shlex
service_path = shlex.quote(service.serve_path)
command.append(service_path)
2. å»ºè®®ä¿®å¤ï¼ˆä¸­ç­‰é£é™©é—®é¢˜ï¼‰
ä¿®å¤1ï¼šæœåŠ¡è·¯å¾„æƒé™æ£€æŸ¥
python

ç¼–è¾‘



# åœ¨_start_service_processæ–¹æ³•ä¸­
if not os.access(service.serve_path, os.R_OK | os.W_OK):
ä¿®å¤2ï¼šæ—¥å¿—çº¿ç¨‹ç»ˆæ­¢
python

ç¼–è¾‘



# åœ¨stop_serviceæ–¹æ³•ä¸­
if service.log_thread_terminate:
    service.log_thread_terminate = True
ä¿®å¤3ï¼šè®¤è¯è§„åˆ™å®‰å…¨å¤„ç†
python

ç¼–è¾‘



# åœ¨_build_commandæ–¹æ³•ä¸­
if service.auth_rules and isinstance(service.auth_rules, list) and len(service.auth_rules) > 0: